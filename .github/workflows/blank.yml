name: snowflake-devops-demo

on:
  push:
    branches:
      - main
    paths:
      - 'migrations/**'
  workflow_dispatch:

jobs:
  deploy-snowflake-changes-job:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Python 3.8.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Diagnostics: show workspace (debug)
        run: |
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          pwd
          ls -la "$GITHUB_WORKSPACE" || true

      - name: Create connections.toml from secrets
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: ${{ secrets.SF_DATABASE }}
          SF_SCHEMA: ${{ secrets.SF_SCHEMA }}
        run: |
          # default SF_SCHEMA to PUBLIC if not provided
          SF_SCHEMA="${SF_SCHEMA:-PUBLIC}"

          # Create a connections.toml file for schemachange v4
          cat > "$GITHUB_WORKSPACE/connections.toml" <<EOF
# connections.toml generated by workflow
[connections.snowflake]
account = "${SF_ACCOUNT}"
user = "${SF_USERNAME}"
password = "${SF_PASSWORD}"
role = "${SF_ROLE}"
warehouse = "${SF_WAREHOUSE}"
database = "${SF_DATABASE}"
schema = "${SF_SCHEMA}"
EOF
          echo "connections.toml created at $GITHUB_WORKSPACE/connections.toml"
          chmod 600 "$GITHUB_WORKSPACE/connections.toml"
          echo "Top of connections.toml (redacted):"
          sed -n '1,8p' "$GITHUB_WORKSPACE/connections.toml"

      - name: Run schemachange (auto-detect migrations & run)
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: ${{ secrets.SF_DATABASE }}
          SF_SCHEMA: ${{ secrets.SF_SCHEMA }}
        run: |
          set -euo pipefail

          # default SF_SCHEMA locally if not set
          SF_SCHEMA="${SF_SCHEMA:-PUBLIC}"

          echo "Step 0: workspace top-level"
          ls -la "$GITHUB_WORKSPACE" || true

          echo "Step 1: look for migrations directory under workspace (depth 6)"
          FOUND=$(find "$GITHUB_WORKSPACE" -maxdepth 6 -type d -name migrations -print -quit || true)

          if [ -n "$FOUND" ]; then
            echo "Found migrations directory at: $FOUND"
            ROOT=$(dirname "$FOUND")
            echo "Using schemachange project root: $ROOT"
          else
            echo "No migrations folder found under workspace. Creating placeholder at $GITHUB_WORKSPACE/migrations"
            mkdir -p "$GITHUB_WORKSPACE/migrations"
            echo "-- placeholder migration" > "$GITHUB_WORKSPACE/migrations/000__placeholder.sql"
            ROOT="$GITHUB_WORKSPACE"
          fi

          echo "Step 2: Install schemachange"
          python -m pip install --upgrade pip
          pip install schemachange --quiet

          # build fully-qualified change-history table name in the runner (not in YAML)
          CHANGE_HISTORY_TABLE="${SF_DATABASE}.SCHEMACHANGE.CHANGE_HISTORY"
          echo "Using CHANGE_HISTORY_TABLE=${CHANGE_HISTORY_TABLE}"

          echo "Step 3: Run schemachange using connections.toml and root: $ROOT"
          schemachange -f "$ROOT" --connections-file "$GITHUB_WORKSPACE/connections.toml" -c "${CHANGE_HISTORY_TABLE}" --create-change-history-table deploy
